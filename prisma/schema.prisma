// LifeLog Database Schema
// Technology: PostgreSQL with Prisma ORM

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER AUTHENTICATION & PROFILE
// ============================================

model User {
  id            String    @id @default(uuid()) @db.Uuid
  name          String?   @db.VarChar(255)
  email         String    @unique @db.VarChar(255)
  emailVerified DateTime? @map("email_verified") @db.Timestamp()
  image         String?   @db.Text
  passwordHash  String?   @map("password_hash") @db.Text // Optional for OAuth users
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamp()

  // Relations
  accounts      Account[]
  sessions      Session[]
  diaryEntries  DiaryEntry[]
  tags          Tag[]
  habits        Habit[]
  notifications Notification[]
  transactions  Transaction[]

  @@map("users")
}

// NextAuth.js OAuth Account model
model Account {
  id                String  @id @default(uuid()) @db.Uuid
  userId            String  @map("user_id") @db.Uuid
  type              String  @db.VarChar(255)
  provider          String  @db.VarChar(255)
  providerAccountId String  @map("provider_account_id") @db.VarChar(255)
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String? @db.VarChar(255)
  scope             String? @db.Text
  id_token          String? @db.Text
  session_state     String? @db.Text

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

// NextAuth.js Session model
model Session {
  id           String   @id @default(uuid()) @db.Uuid
  sessionToken String   @unique @map("session_token") @db.VarChar(255)
  userId       String   @map("user_id") @db.Uuid
  expires      DateTime @db.Timestamp()

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

// NextAuth.js Verification Token model
model VerificationToken {
  identifier String   @db.VarChar(255)
  token      String   @unique @db.VarChar(255)
  expires    DateTime @db.Timestamp()

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================
// DIARY ENTRIES
// ============================================

model DiaryEntry {
  id           String   @id @default(uuid()) @db.Uuid
  userId       String   @map("user_id") @db.Uuid
  title        String?  @db.VarChar(255)
  entryDate    DateTime @default(now()) @map("entry_date") @db.Date
  content      String   @db.Text
  mood         String   @db.VarChar(50)
  highlight    String?  @db.Text
  gratitude    String?  @db.Text
  expense      Decimal? @db.Decimal(10, 2)
  expenseTitle String?  @map("expense_title") @db.VarChar(255)
  expenseDesc  String?  @map("expense_desc") @db.Text
  expenseType  String?  @default("expense") @map("expense_type") @db.VarChar(50)
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamp()
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamp()

  // Relations
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  attachments  Attachment[]
  entryTags    EntryTag[]
  transactions Transaction[]

  @@index([userId])
  @@index([entryDate])
  @@index([userId, entryDate])
  @@map("diary_entries")
}

// ============================================
// TRANSACTIONS (Financial Tracking)
// ============================================

model Transaction {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  entryId     String?  @map("entry_id") @db.Uuid
  type        String   @db.VarChar(50) // "income" or "expense"
  amount      Decimal  @db.Decimal(10, 2)
  title       String   @db.VarChar(255)
  description String?  @db.Text
  category    String?  @db.VarChar(100)
  date        DateTime @default(now()) @db.Date
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp()

  // Relations
  user  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  entry DiaryEntry? @relation(fields: [entryId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([userId, date])
  @@index([userId, type])
  @@index([entryId])
  @@map("transactions")
}

// ============================================
// TAGS & ORGANIZATION
// ============================================

model Tag {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  name      String   @db.VarChar(50)
  color     String?  @db.VarChar(7) // Hex color code (e.g., #FF5733)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp()

  // Relations
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  entryTags EntryTag[]

  @@unique([userId, name])
  @@index([userId])
  @@map("tags")
}

// Many-to-many join table for diary entries and tags
model EntryTag {
  entryId String @map("entry_id") @db.Uuid
  tagId   String @map("tag_id") @db.Uuid

  // Relations
  entry DiaryEntry @relation(fields: [entryId], references: [id], onDelete: Cascade)
  tag   Tag        @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([entryId, tagId])
  @@index([entryId])
  @@index([tagId])
  @@map("entry_tags")
}

// ============================================
// MEDIA ATTACHMENTS
// ============================================

model Attachment {
  id        String   @id @default(uuid()) @db.Uuid
  entryId   String   @map("entry_id") @db.Uuid
  fileUrl   String   @map("file_url") @db.Text
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp()

  // Relations
  entry DiaryEntry @relation(fields: [entryId], references: [id], onDelete: Cascade)

  @@index([entryId])
  @@map("attachments")
}

// ============================================
// HABIT TRACKING
// ============================================

model Habit {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  name      String   @db.VarChar(255)
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp()

  // Relations
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  habitLogs HabitLog[]

  @@index([userId])
  @@index([userId, isActive])
  @@map("habits")
}

model HabitLog {
  id          String   @id @default(uuid()) @db.Uuid
  habitId     String   @map("habit_id") @db.Uuid
  logDate     DateTime @map("log_date") @db.Date
  isCompleted Boolean  @default(false) @map("is_completed")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp()

  // Relations
  habit Habit @relation(fields: [habitId], references: [id], onDelete: Cascade)

  @@unique([habitId, logDate])
  @@index([habitId])
  @@index([logDate])
  @@map("habit_logs")
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  title     String   @db.VarChar(255)
  message   String   @db.Text
  isRead    Boolean  @default(false) @map("is_read")
  type      String   @default("info") @db.VarChar(50) // info, reminder, achievement
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp()

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, isRead])
  @@map("notifications")
}
